

# Secure a .NET Framework web app (OWIN) with OpenID Connect


Learn how to restrict access to your ASP.NET Framework MVC web application to clients that have authenticated with Azure Active Directory B2C (Azure AD B2C). This sample covers calling an OpenID Connect identity provider (Azure AD B2C) using [OpenID Connect is an authentication protocol](https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-reference-oidc). 

## How the sample app generated by this guide works

![OIDC flow](https://docs.microsoft.com/en-us/azure/active-directory/develop/media/active-directory-develop-guidedsetup-aspnetwebapp-intro/aspnetbrowsergeneral.svg)

## Prerequisites

You need the following resources in place before continuing with the steps in this article:

* [Azure AD B2C tenant](tutorial-create-tenant.md)
* [Application registered](tutorial-register-applications.md) in your tenant
* [User flows](tutorial-create-user-flows.md), or [custom policies](https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-get-started-custom?tabs=applications) are create in your tenant

## Get Azure AD B2C application ID

When you secure an web API with Azure AD B2C, you need to specify the list of apps (web/mobile SPA applications) that are allow to access the web API. First, record the application ID of an application you've previously created in your Azure AD B2C tenant. If you're using the application you created in the prerequisites, use the application ID for *webbapp1*.

1. Browse to your Azure AD B2C tenant in the [Azure portal](https://portal.azure.com).
1. Under **Manage**, select **Applications**.
1. Record the value in the **APPLICATION ID** for *webapp1* or another application you've previously created.

  ![Location of a B2C application's Application ID in the Azure portal](https://docs.microsoft.com/en-us/azure/active-directory-b2c/media/secure-apim-with-b2c-token/portal-02-app-id.png)

## Get token metadata endpoint

Next, get the well-known config URL for one of your Azure AD B2C user flows. 

1. Browse to your Azure AD B2C tenant in the [Azure portal](https://portal.azure.com).
1. Under **Policies**, select **User flows (policies)**.
1. Select an existing policy, for example *B2C_1_signupsignin1*, then select **Run user flow**.
1. Record the URL in hyperlink displayed under the **Run user flow** heading near the top of the page. This URL is the OpenID Connect metadata endpoint for the user flow, and you use it in the next section when you configure the authentication middleware.

    ![Well-known URI hyperlink in the Run now page of the Azure portal](https://docs.microsoft.com/en-us/azure/active-directory-b2c/media/secure-apim-with-b2c-token/portal-01-policy-link.png)


## 1. Setup your web application

This section describes how to install and configure the authentication pipeline through OWIN middleware on an ASP.NET project by using OpenID Connect.

Create a web app project:

* From the **File** menu, select **New** > **Project**.
* Select the **ASP.NET Web Application (.NET Framework)** template and click **Next**.
* Name the project *SampleWebApp* and click **Create**.
* In the **Create a new ASP.NET Web Application** dialog, select the **MVC** template, do NOT select **Enable Docker Support**, and click **Create**. 

![VS new project dialog](media/create-webapi-vs.png)

## 2. Add authentication components

This sample app uses the following libraries:

- [Microsoft.Owin.Security.OpenIdConnect](https://www.nuget.org/packages/Microsoft.Owin.Security.OpenIdConnect/) - Middleware that enables an application to use OpenIdConnect for authentication
- [Microsoft.Owin.Security.Cookies](https://www.nuget.org/packages/Microsoft.Owin.Security.Cookies) - Middleware that enables an application to maintain a user session by using cookies
- [Microsoft.Owin.Host.SystemWeb](https://www.nuget.org/packages/Microsoft.Owin.Host.SystemWeb) Middleware that enables OWIN-based applications to run on Internet Information Services (IIS) by using the ASP.NET request pipeline

These libraries enable single sign-on (SSO) by using OpenID Connect through cookie-based authentication. After authentication is completed and the token representing the user is sent to your application, OWIN middleware creates a session cookie. The browser then uses this cookie on subsequent requests so that the user doesn't have to retype the password, and no additional verification is needed.

1. In Visual Studio: Go to **Tools** > **Nuget Package Manager** > **Package Manager Console**.
2. Add *OWIN middleware NuGet packages* by typing the following in the Package Manager Console window:

    ```powershell
    Install-Package Microsoft.Owin.Security.OpenIdConnect
    Install-Package Microsoft.Owin.Security.Cookies
    Install-Package Microsoft.Owin.Host.SystemWeb
    ```

## 3. Configure the authentication pipeline

The following steps are used to create an OWIN middleware Startup class to configure OpenID Connect authentication. This class is executed automatically when your IIS process starts.

If your project doesn't have a `Startup.cs` file in the root folder:

1. Right-click the project's root folder, and then select **Add** > **New Item** > **OWIN Startup class**.<br/>
1. Name it **Startup.cs**.

> Make sure the class selected is an OWIN Startup class and not a standard C# class. Confirm this by verifying that you see [assembly: OwinStartup(typeof({NameSpace}.Startup))] above the namespace.

1. Add *OWIN* and *Microsoft.IdentityModel* references to Startup.cs:

    ```csharp
    using Microsoft.Owin;
    using Owin;
    using Microsoft.IdentityModel.Protocols.OpenIdConnect;
    using Microsoft.IdentityModel.Tokens;
    using Microsoft.Owin.Security;
    using Microsoft.Owin.Security.Cookies;
    using Microsoft.Owin.Security.OpenIdConnect;
    using Microsoft.Owin.Security.Notifications;
    using System.Threading.Tasks;
    using System.Configuration;
    ```

2. Replace Startup class with the following code:

    ```csharp
    public  class Startup
    {
        // App config settings
        public static string ClientId = ConfigurationManager.AppSettings["ida:ClientId"];
        public static string WellKnownMetadata = ConfigurationManager.AppSettings["ida:MetadataEndpoint"];
        public static string RedirectUri = ConfigurationManager.AppSettings["ida:RedirectUri"];

        // B2C policy identifiers
        public static string SignUpSignInPolicyId = ConfigurationManager.AppSettings["ida:SignUpSignInPolicyId"];
        public static string EditProfilePolicyId = ConfigurationManager.AppSettings["ida:EditProfilePolicyId"];
        public static string ResetPasswordPolicyId = ConfigurationManager.AppSettings["ida:ResetPasswordPolicyId"];

        public static string DefaultPolicy = SignUpSignInPolicyId;


        // The OWIN middleware will invoke this method when the app starts
        public void Configuration(IAppBuilder app)
        {
            // Required for Azure webapps, as by default they force TLS 1.2 and this project attempts 1.0
            //ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

            app.SetDefaultSignInAsAuthenticationType(CookieAuthenticationDefaults.AuthenticationType);

            app.UseCookieAuthentication(new CookieAuthenticationOptions());

            app.UseOpenIdConnectAuthentication(
                new OpenIdConnectAuthenticationOptions
                {
                    // Generate the metadata address using the tenant and policy information
                    MetadataAddress = WellKnownMetadata,

                    // These are standard OpenID Connect parameters, with values pulled from web.config
                    ClientId = ClientId,
                    RedirectUri = RedirectUri,
                    PostLogoutRedirectUri = RedirectUri,

                    // Specify the callbacks for each type of notifications
                    Notifications = new OpenIdConnectAuthenticationNotifications
                    {
                        RedirectToIdentityProvider = OnRedirectToIdentityProvider,
                        AuthenticationFailed = OnAuthenticationFailed,
                    },

                    // Specify the claim type that specifies the Name property.
                    TokenValidationParameters = new TokenValidationParameters
                    {
                        NameClaimType = "name",
                        ValidateIssuer = false
                    },

                    // Specify the scope by appending all of the scopes requested into one string (separated by a blank space)
                    Scope = OpenIdConnectScope.OpenIdProfile
                }
            );
        }

        /*
        *  On each call to Azure AD B2C, check if a policy (e.g. the profile edit or password reset policy) has been specified in the OWIN context.
        *  If so, use that policy when making the call. Also, don't request a code (since it won't be needed).
        */
        private Task OnRedirectToIdentityProvider(RedirectToIdentityProviderNotification<OpenIdConnectMessage, OpenIdConnectAuthenticationOptions> notification)
        {
            var policy = notification.OwinContext.Get<string>("Policy");

            if (!string.IsNullOrEmpty(policy) && !policy.Equals(DefaultPolicy))
            {
                notification.ProtocolMessage.Scope = OpenIdConnectScope.OpenId;
                notification.ProtocolMessage.ResponseType = OpenIdConnectResponseType.IdToken;
                notification.ProtocolMessage.IssuerAddress = notification.ProtocolMessage.IssuerAddress.ToLower().Replace(DefaultPolicy.ToLower(), policy.ToLower());
            }

            return Task.FromResult(0);
        }

        /*
         * Catch any failures received by the authentication middleware and handle appropriately
         */
        private Task OnAuthenticationFailed(AuthenticationFailedNotification<OpenIdConnectMessage, OpenIdConnectAuthenticationOptions> notification)
        {
            notification.HandleResponse();

            // Handle the error code that Azure AD B2C throws when trying to reset a password from the login page
            // because password reset is not supported by a "sign-up or sign-in policy"
            if (notification.ProtocolMessage.ErrorDescription != null && notification.ProtocolMessage.ErrorDescription.Contains("AADB2C90118"))
            {
                // If the user clicked the reset password link, redirect to the reset password route
                notification.Response.Redirect("/Account/ResetPassword");
            }
            else if (notification.Exception.Message == "access_denied")
            {
                notification.Response.Redirect("/");
            }
            else
            {
                notification.Response.Redirect("/Home/Error?message=" + notification.Exception.Message);
            }

            return Task.FromResult(0);
        }
    }    ```

## 4. Add a controller to handle sign-in and sign-out requests

To create a new controller to expose sign-in and sign-out methods, follow these steps:

1.	Right-click the **Controllers** folder and select **Add** > **Controller**.
2.	Select **MVC (.NET version) Controller â€“ Empty**.
3.	Select **Add**.
4.	Name it **AccountController** and then select **Add**.
5.	Replace the code with the following:

    ```csharp
    using Microsoft.Owin.Security;
    using SampleWebApp1;
    using System.Collections.Generic;
    using System.Linq;
    using System.Web;
    using System.Web.Mvc;

    namespace SamplekWebApp.Controllers
    {
        public class AccountController : Controller
        {
            /*
            *  Called when requesting to sign up or sign in
            */
            public void SignUpSignIn(string redirectUrl)
            {
                redirectUrl = redirectUrl ?? "/";

                // Use the default policy to process the sign up / sign in flow
                HttpContext.GetOwinContext().Authentication.Challenge(new AuthenticationProperties { RedirectUri = redirectUrl });
                return;
            }

            /*
            *  Called when requesting to edit a profile
            */
            public void EditProfile()
            {
                if (Request.IsAuthenticated)
                {
                    // Let the middleware know you are trying to use the edit profile policy (see OnRedirectToIdentityProvider in Startup.Auth.cs)
                    HttpContext.GetOwinContext().Set("Policy", Startup.EditProfilePolicyId);

                    // Set the page to redirect to after editing the profile
                    var authenticationProperties = new AuthenticationProperties { RedirectUri = "/" };
                    HttpContext.GetOwinContext().Authentication.Challenge(authenticationProperties);

                    return;
                }

                Response.Redirect("/");
            }

            /*
            *  Called when requesting to reset a password
            */
            public void ResetPassword()
            {
                // Let the middleware know you are trying to use the reset password policy (see OnRedirectToIdentityProvider in Startup.Auth.cs)
                HttpContext.GetOwinContext().Set("Policy", Startup.ResetPasswordPolicyId);

                // Set the page to redirect to after changing passwords
                var authenticationProperties = new AuthenticationProperties { RedirectUri = "/" };
                HttpContext.GetOwinContext().Authentication.Challenge(authenticationProperties);

                return;
            }

            /*
            *  Called when requesting to sign out
            */
            public void SignOut()
            {
                // To sign out the user, you should issue an OpenIDConnect sign out request.
                if (Request.IsAuthenticated)
                {
                    IEnumerable<AuthenticationDescription> authTypes = HttpContext.GetOwinContext().Authentication.GetAuthenticationTypes();
                    HttpContext.GetOwinContext().Authentication.SignOut(authTypes.Select(t => t.AuthenticationType).ToArray());
                    Request.GetOwinContext().Authentication.GetAuthenticationTypes();
                }
            }
        }
    }
    ```

## 5. Add sign-in, edit profile and sign-out buttons

In Visual Studio, create a new view to add the sign-in button and to display user information after authentication:

1.	Right-click the **Views\Shared** folder and select **Add View**.
1.	Name the new view **_LoginPartial**.
1. Select **Create as a partial view** and click **Add**
1.	Add the following code, which includes the sign-in button, to the file:
    
    ```HTML
    @if (Request.IsAuthenticated)
    {
        <text>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a id="profile-link">@User.Identity.Name</a>
                    <div id="profile-options" class="nav navbar-nav navbar-right">
                        <ul class="profile-links">
                            <li class="profile-link">
                                @Html.ActionLink("Edit Profile", "EditProfile", "Account")
                            </li>
                            <li class="profile-link">
                                @Html.ActionLink("Reset Password", "ResetPassword", "Account")
                            </li>
                        </ul>
                    </div>
                </li>
                <li>
                    @Html.ActionLink("Sign out", "SignOut", "Account")
                </li>
            </ul>
        </text>
    }
    else
    {
        <ul class="nav navbar-nav navbar-right">
            <li>@Html.ActionLink("Sign up / Sign in", "SignUpSignIn", "Account", routeValues: null, htmlAttributes: new { id = "signUpSignInLink" })</li>
        </ul>
    }
    ```
    
1.	Open the **Views\Shared\_Layout.cshtml** file.
1. Locate the DIV element `<div class="navbar-collapse collapse">`
1.	Add following snippet just before the closing tag

    ```
    @Html.Partial("_LoginPartial")
    ```

Your final **_Layout.cshtml**should look like following:

```HTML
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - My ASP.NET Application</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                @Html.ActionLink("Application name", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li>@Html.ActionLink("Home", "Index", "Home")</li>
                    <li>@Html.ActionLink("About", "About", "Home")</li>
                    <li>@Html.ActionLink("Contact", "Contact", "Home")</li>
                </ul>
                @Html.Partial("_LoginPartial")
            </div>
        </div>
    </div>
    <div class="container body-content">
        @RenderBody()
        <hr />
        <footer>
            <p>&copy; @DateTime.Now.Year - My ASP.NET Application</p>
        </footer>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)
</body>
</html>

```

## 6. Add the application settings

Open your **web.config** file and add following entries to the `<appSettings>` section. Replace the:

* **ida:MetadataEndpoint** with your Azure AD B2C user flow metadata URI.
* **ida:ClientIds** Application ID you just registered.
* **ida:RedirectUri** the SSL URL of your project.
* **ida:SignUpSignInPolicyId** the name of the sign-up and sign-in policy
* **ida:EditProfilePolicyId** the name of the edit profile policy
* **ida:ResetPasswordPolicyId** the name of the password reset policy

```XML
<add key="ida:MetadataEndpoint" value="https://yourtenant.b2clogin.com/yourtenant.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=B2C_1_susi" />
<add key="ida:ClientId" value="00000000-0000-0000-0000-000000000000" />
<add key="ida:RedirectUri" value="https://localhost:44314/" />
<add key="ida:SignUpSignInPolicyId" value="B2C_1_susi" />
<add key="ida:EditProfilePolicyId" value="b2c_1_edit_profile" />
<add key="ida:ResetPasswordPolicyId" value="b2c_1_reset" />
```
